name: CI - Fast API 34

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:

      # -------------------------------------------------
      # 1. Checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # -------------------------------------------------
      # 2. Java
      # -------------------------------------------------
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # -------------------------------------------------
      # 3. Gradle cache
      # -------------------------------------------------
      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      # -------------------------------------------------
      # 4. No AVD cache (VERY important for API-34)
      # -------------------------------------------------
      - name: Disable AVD cache
        run: echo "AVD cache disabled for API-34 stability"

      # -------------------------------------------------
      # 5. gradlew executable
      # -------------------------------------------------
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # -------------------------------------------------
      # 6. local.properties
      # -------------------------------------------------
      - name: Create local.properties
        env:
          LOCAL_PROPERTIES: ${{ secrets.LOCAL_PROPERTIES }}
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          if [ -n "$LOCAL_PROPERTIES" ]; then
            echo "$LOCAL_PROPERTIES" | base64 --decode >> local.properties
          fi

      # -------------------------------------------------
      # 7. google-services.json
      # -------------------------------------------------
      - name: Decode google-services.json
        env:
          GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}
        run: |
          if [ -n "$GOOGLE_SERVICES" ]; then
            echo "$GOOGLE_SERVICES" | base64 --decode > app/google-services.json
          fi

      # -------------------------------------------------
      # 8. Formatting
      # -------------------------------------------------
      - name: KTFmt Check
        run: ./gradlew ktfmtCheck --stacktrace

      # -------------------------------------------------
      # 9. Build before emulator (faster overall)
      # -------------------------------------------------
      - name: Assemble & Lint
        run: ./gradlew assemble lint --stacktrace --build-cache

      # -------------------------------------------------
      # 10. Unit tests
      # -------------------------------------------------
      - name: Unit tests
        env:
          CI: true
        run: ./gradlew check --stacktrace --build-cache

      # -------------------------------------------------
      # 11. API 34 FAST EMULATOR + connected tests
      # -------------------------------------------------
      - name: Instrumented Tests (API 34)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          force-avd-creation: true
          disable-animations: true
          emulator-options: >
            -no-snapshot
            -no-snapshot-save
            -no-window
            -gpu swiftshader_indirect
            -noaudio
            -camera-back none
            -no-boot-anim
            -skin 480x800
            -dpi-device 160
          script: |
            echo "[ADB] Stabilizing..."
            adb kill-server || true
            adb start-server
            adb devices
            
            echo "[SYSTEM] Extra wait for services..."
            sleep 12

            echo "[TEST] Running connectedCheck..."
            ./gradlew connectedCheck --stacktrace --build-cache

      # -------------------------------------------------
      # 12. Firebase emulator starts AFTER Android tests
      # -------------------------------------------------
      - name: Start Firebase Emulators (after boot)
        run: |
          firebase emulators:start --only firestore,auth --project demo-test --debug > firebase.log 2>&1 &
          sleep 10

      # -------------------------------------------------
      # 13. Coverage
      # -------------------------------------------------
      - name: Coverage
        run: ./gradlew jacocoTestReport --stacktrace

      # -------------------------------------------------
      # 14. SonarCloud
      # -------------------------------------------------
      - name: SonarCloud Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew sonar --stacktrace --build-cache

      # -------------------------------------------------
      # 15. Debug logs on failure
      # -------------------------------------------------
      - name: Debug logs on failure
        if: failure()
        run: |
          echo "==== DEBUG: CI FAILURE ===="
          find ~/.gradle/daemon -type f -name "*.log" -exec tail -n 200 {} \;
          adb devices || true

      - name: Upload reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-reports
          path: |
            **/build/reports/
            ~/.gradle/daemon/
            firebase.log
