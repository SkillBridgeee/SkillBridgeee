rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // PRODUCTION RULES - Use these when deploying to production
    // To deploy: Copy these rules to firestore.rules and run: firebase deploy --only firestore:rules

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Users/Profiles collection
    match /profiles/{userId} {
      // Allow get/list if authenticated
      allow get, list: if isAuthenticated();

      // Allow create/update if user is authenticated and owns the profile
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId);

      // Allow delete only by owner
      allow delete: if isOwner(userId);

      // Skills subcollection under profiles
      match /skills/{skillId} {
        // Anyone can read skills
        allow read: if isAuthenticated();

        // Only profile owner can write skills
        allow write: if isOwner(userId);
      }
    }

    // Listings collection
    match /listings/{listingId} {
      // Allow get/list if authenticated
      allow get, list: if isAuthenticated();

      // Allow create if authenticated
      allow create: if isAuthenticated();

      // Allow update/delete only by the creator
      allow update, delete: if isAuthenticated() &&
                               resource.data.userId == request.auth.uid;
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Allow get if authenticated and user is either booker or listing creator
      allow get: if isAuthenticated() &&
                    (resource.data.bookerId == request.auth.uid ||
                     resource.data.listingCreatorId == request.auth.uid);

      // Allow list for all authenticated users
      allow list: if isAuthenticated();

      // Allow create if authenticated
      allow create: if isAuthenticated();

      // Allow update/delete by booker or listing creator
      allow update, delete: if isAuthenticated() &&
                               (resource.data.bookerId == request.auth.uid ||
                                resource.data.listingCreatorId == request.auth.uid);
    }

    // Ratings collection
    match /ratings/{ratingId} {
      // Allow get/list if authenticated
      allow get, list: if isAuthenticated();

      // Allow create if authenticated
      allow create: if isAuthenticated();

      // Allow update/delete only by the creator
      allow update, delete: if isAuthenticated() &&
                               resource.data.reviewerId == request.auth.uid;
    }

    // Conversations collection
    match /conversations/{convId} {
      // Helper function to check if user is participant in conversation
      function isParticipant() {
        return isAuthenticated() &&
               (resource.data.convCreatorId == request.auth.uid ||
                resource.data.otherPersonId == request.auth.uid);
      }

      function isParticipantCreate() {
        return isAuthenticated() &&
               (request.resource.data.convCreatorId == request.auth.uid ||
                request.resource.data.otherPersonId == request.auth.uid);
      }

      // Allow read if user is a participant in the conversation
      allow get: if isParticipant();

      // Allow list for authenticated users (they'll only see their conversations via queries)
      allow list: if isAuthenticated();

      // Allow create if user is one of the participants
      allow create: if isParticipantCreate();

      // Allow update if user is a participant (for updating messages, etc.)
      allow update: if isParticipant();

      // Allow delete if user is a participant
      allow delete: if isParticipant();

      // Messages subcollection
      match /messages/{msgId} {
        // Allow read if parent conversation allows it (user is participant)
        allow read: if isAuthenticated() &&
                       (get(/databases/$(database)/documents/conversations/$(convId)).data.convCreatorId == request.auth.uid ||
                        get(/databases/$(database)/documents/conversations/$(convId)).data.otherPersonId == request.auth.uid);

        // Allow write if user is sender or receiver of the message
        allow create: if isAuthenticated() &&
                         (request.resource.data.senderId == request.auth.uid ||
                          request.resource.data.receiverId == request.auth.uid);

        allow update, delete: if isAuthenticated() &&
                                 resource.data.senderId == request.auth.uid;
      }
    }

    // OverViewConv collection (conversation overviews for users)
    match /overViewConv/{overviewId} {
      // Allow read if user owns this overview OR is the other participant
      // This allows reading/updating overview when the user is involved in the conversation
      allow get: if isAuthenticated() &&
                    (resource.data.overViewOwnerId == request.auth.uid ||
                     resource.data.otherPersonId == request.auth.uid);

      // Allow list for authenticated users (filtered by get rules)
      allow list: if isAuthenticated();

      // Allow create if user is the owner OR the other person in the conversation
      // This allows creating overviews for both participants when starting a conversation
      allow create: if isAuthenticated() &&
                       (request.resource.data.overViewOwnerId == request.auth.uid ||
                        request.resource.data.otherPersonId == request.auth.uid);

      // Allow update if user owns the overview OR is the other participant
      // This allows updating overview (e.g., unread count) when sending/receiving messages
      allow update: if isAuthenticated() &&
                       (resource.data.overViewOwnerId == request.auth.uid ||
                        resource.data.otherPersonId == request.auth.uid);

      // Allow delete if user owns the overview
      allow delete: if isAuthenticated() &&
                       resource.data.overViewOwnerId == request.auth.uid;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

